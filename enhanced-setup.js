#!/usr/bin/env node

/**
 * Enhanced Setup Script for Qwen Code Internal LLM
 * Implements SetupWizard functionality without complex imports
 */

import fs from 'fs';
import path from 'path';
import { homedir } from 'os';
import http from 'http';
import https from 'https';

const USER_SETTINGS_DIR = path.join(homedir(), '.qwen');
const GLOBAL_ENV_PATH = path.join(USER_SETTINGS_DIR, '.env');
const LOCAL_ENV_PATH = path.join(process.cwd(), '.env');

console.log('ðŸš€ Qwen Code Enhanced Setup Wizard');
console.log('=====================================');

// ì„œë²„ ë°œê²¬ì„ ìœ„í•œ í›„ë³´ URLë“¤
const CANDIDATE_URLS = [
  'http://localhost:8443/devport/api/v1',  // í…ŒìŠ¤íŠ¸ í”„ë¡ì‹œ ì„œë²„
  'http://localhost:8443/api/v1',
  'http://localhost:8080/api/v1',
  'http://localhost:3000/api/v1',
  'https://localhost:8443/api/v1',
  'http://127.0.0.1:8443/api/v1',
];

// ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
async function testServerConnection(url) {
  return new Promise((resolve) => {
    const startTime = Date.now();
    const isHttps = url.startsWith('https://');
    const client = isHttps ? https : http;
    
    // ê°„ë‹¨í•œ POST ìš”ì²­ìœ¼ë¡œ chat/completions ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
    const testUrl = `${url}/chat/completions`;
    const testData = JSON.stringify({
      model: 'test',
      messages: [{ role: 'user', content: 'ping' }],
      max_tokens: 1
    });
    
    const req = client.request(testUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(testData),
        'Authorization': 'Bearer test-key'
      },
      timeout: 3000,
      ...(isHttps && { rejectUnauthorized: false }),
    }, (res) => {
      const responseTime = Date.now() - startTime;
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });
      
      res.on('end', () => {
        // 200ì´ë‚˜ 400ë²ˆëŒ€ë„ ì„œë²„ê°€ ì‘ë‹µí•œë‹¤ë©´ ê±´ê°•í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼
        const isHealthy = res.statusCode >= 200 && res.statusCode < 500;
        resolve({
          url,
          isHealthy,
          responseTime,
          status: res.statusCode,
        });
      });
    });

    req.on('error', () => {
      resolve({
        url,
        isHealthy: false,
        responseTime: -1,
        status: 'ERROR',
      });
    });

    req.setTimeout(3000, () => {
      req.destroy();
      resolve({
        url,
        isHealthy: false,
        responseTime: -1,
        status: 'TIMEOUT',
      });
    });

    req.write(testData);
    req.end();
  });
}

// ì„œë²„ ìžë™ ë°œê²¬
async function discoverServers() {
  console.log('\nðŸ” Discovering internal LLM servers...');
  const results = [];
  
  for (const url of CANDIDATE_URLS) {
    process.stdout.write(`  Testing ${url}... `);
    const result = await testServerConnection(url);
    
    if (result.isHealthy) {
      console.log(`âœ… OK (${result.responseTime}ms)`);
      results.push(result);
    } else {
      console.log(`âŒ ${result.status}`);
    }
  }
  
  return results.sort((a, b) => a.responseTime - b.responseTime);
}

// ì„¤ì • í…œí”Œë¦¿ ìƒì„±
function generateConfigTemplate(config) {
  return `# Qwen Code Internal LLM Configuration
# Generated by Enhanced Setup Wizard

# LLM Server Configuration
INTERNAL_LLM_BASE_URL=${config.baseUrl}
INTERNAL_LLM_API_KEY=${config.apiKey}
INTERNAL_LLM_MODEL=${config.model}

# Optional Settings
${config.skipSSLVerification ? 'NODE_TLS_REJECT_UNAUTHORIZED=0' : '# NODE_TLS_REJECT_UNAUTHORIZED=0'}

# Debug Settings (uncomment if needed)
# DEBUG=1
# INTERNAL_LLM_VERBOSE=true

# Generated on: ${new Date().toISOString()}
`;
}

// ì„¤ì • ì €ìž¥
function saveConfig(config, scope = 'global') {
  const configContent = generateConfigTemplate(config);
  const configPath = scope === 'global' ? GLOBAL_ENV_PATH : LOCAL_ENV_PATH;
  
  // ë””ë ‰í† ë¦¬ ìƒì„± (ê¸€ë¡œë²Œì¸ ê²½ìš°)
  if (scope === 'global' && !fs.existsSync(USER_SETTINGS_DIR)) {
    fs.mkdirSync(USER_SETTINGS_DIR, { recursive: true });
    console.log(`ðŸ“ Created settings directory: ${USER_SETTINGS_DIR}`);
  }
  
  // ê¸°ì¡´ ì„¤ì • ë°±ì—…
  if (fs.existsSync(configPath)) {
    const backupPath = `${configPath}.backup.${Date.now()}`;
    fs.copyFileSync(configPath, backupPath);
    console.log(`ðŸ“¦ Backed up existing config to: ${backupPath}`);
  }
  
  // ìƒˆ ì„¤ì • ì €ìž¥
  fs.writeFileSync(configPath, configContent, 'utf8');
  console.log(`âœ… Configuration saved to: ${configPath}`);
  
  return configPath;
}

// ê¸°ì¡´ ì„¤ì • í™•ì¸
function checkExistingConfigs() {
  const hasLocal = fs.existsSync(LOCAL_ENV_PATH);
  const hasGlobal = fs.existsSync(GLOBAL_ENV_PATH);
  
  console.log('\nðŸ“‹ Checking existing configurations...');
  
  if (hasLocal) {
    console.log(`ðŸ“ Found local config: ${LOCAL_ENV_PATH}`);
  }
  
  if (hasGlobal) {
    console.log(`ðŸŒ Found global config: ${GLOBAL_ENV_PATH}`);
  }
  
  if (!hasLocal && !hasGlobal) {
    console.log('ðŸ“­ No existing configurations found');
  }
  
  return { hasLocal, hasGlobal };
}

// ìžë™ ì„¤ì • ë©”ì¸ í•¨ìˆ˜
async function autoSetup() {
  try {
    // ê¸°ì¡´ ì„¤ì • í™•ì¸
    checkExistingConfigs();
    
    // ì„œë²„ ìžë™ ë°œê²¬
    const healthyServers = await discoverServers();
    
    if (healthyServers.length === 0) {
      console.log('\nâŒ No healthy servers found automatically.');
      console.log('\nðŸ’¡ Try these solutions:');
      console.log('  â€¢ Start your internal LLM server');
      console.log('  â€¢ Check if the server is running on a standard port (8443, 8080, 3000)');
      console.log('  â€¢ Verify network connectivity');
      console.log('  â€¢ Run manual setup with custom server URL');
      return false;
    }
    
    // ìµœì  ì„œë²„ ì„ íƒ
    const bestServer = healthyServers[0];
    console.log(`\nâœ… Selected best server: ${bestServer.url} (${bestServer.responseTime}ms)`);
    
    // ê¸°ë³¸ ì„¤ì • ìƒì„±
    const config = {
      baseUrl: bestServer.url,
      apiKey: 'test-key',  // ê°œë°œìš© ê¸°ë³¸ê°’
      model: 'internal-llm-model',  // ê¸°ë³¸ ëª¨ë¸ëª…
      skipSSLVerification: bestServer.url.includes('localhost') && bestServer.url.startsWith('https://'),
    };
    
    // ì„¤ì • ì €ìž¥ (ê¸€ë¡œë²Œ)
    const configPath = saveConfig(config, 'global');
    
    console.log('\nðŸŽ‰ Automatic setup completed successfully!');
    console.log('\nðŸ“ Next steps:');
    console.log('  1. Update the API key in your configuration file if needed');
    console.log('  2. Start your internal LLM server');
    console.log('  3. Run: qwen /validate');
    console.log('  4. Start using: qwen');
    
    console.log('\nðŸ’¡ Additional commands:');
    console.log('  â€¢ qwen /diagnose - Quick connection test');
    console.log('  â€¢ qwen /validate - Comprehensive validation');
    
    if (config.apiKey === 'test-key') {
      console.log('\nâš ï¸  Note: Please update the API key in your configuration file:');
      console.log(`     ${configPath}`);
    }
    
    return true;
    
  } catch (error) {
    console.error('\nðŸ’¥ Auto setup failed:', error.message);
    return false;
  }
}

// ìˆ˜ë™ ì„¤ì • ê°€ì´ë“œ
function showManualSetup() {
  console.log('\nðŸ“ Manual Setup Instructions');
  console.log('============================');
  
  console.log('\n1. Create configuration file:');
  console.log('   Global: ~/.qwen/.env');
  console.log('   Local: ./.env');
  
  console.log('\n2. Add these variables:');
  console.log('   INTERNAL_LLM_BASE_URL=http://localhost:8443/api/v1');
  console.log('   INTERNAL_LLM_API_KEY=your-api-key');
  console.log('   INTERNAL_LLM_MODEL=your-model-name');
  console.log('   NODE_TLS_REJECT_UNAUTHORIZED=0  # For development only');
  
  console.log('\n3. Test configuration:');
  console.log('   qwen /validate');
  
  console.log('\n4. Start using:');
  console.log('   qwen');
}

// ë©”ì¸ ì‹¤í–‰
async function main() {
  const success = await autoSetup();
  
  if (!success) {
    showManualSetup();
  }
}

// ì—ëŸ¬ í•¸ë“¤ë§
process.on('unhandledRejection', (reason, promise) => {
  console.error('\nðŸ’¥ Unhandled Promise Rejection:', reason);
  process.exit(1);
});

process.on('uncaughtException', (error) => {
  console.error('\nðŸ’¥ Uncaught Exception:', error.message);
  process.exit(1);
});

// ì‹¤í–‰
main().catch(error => {
  console.error('\nðŸ’¥ Setup failed:', error.message);
  showManualSetup();
  process.exit(1);
});